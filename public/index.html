<!DOCTYPE html>
<html lang="it">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Asta Fantacalcio Live</title>
		<script src="https://cdn.tailwindcss.com"></script>
		<script
			crossorigin
			src="https://unpkg.com/react@18/umd/react.development.js"></script>
		<script
			crossorigin
			src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
		<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
		<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
		<style>
			body {
				background: radial-gradient(
						1200px 600px at 20% -10%,
						rgba(59, 130, 246, 0.08),
						transparent
					),
					radial-gradient(
						900px 400px at 120% 10%,
						rgba(16, 185, 129, 0.06),
						transparent
					),
					#0b1220;
			}
			.glass {
				background: rgba(255, 255, 255, 0.06);
				backdrop-filter: blur(10px);
			}
			.shine {
				background: linear-gradient(
					110deg,
					rgba(255, 255, 255, 0.05),
					transparent 40%
				);
			}
			.price {
				display: inline-block;
				transition: transform 0.22s ease, color 0.22s ease,
					text-shadow 0.22s ease;
			}
			.price-bump {
				transform: scale(1.12);
				color: #fbbf24;
				text-shadow: 0 0 10px rgba(251, 191, 36, 0.45);
			}
			.toast-wrap {
				position: fixed;
				top: 12px;
				right: 12px;
				z-index: 9999;
				display: flex;
				flex-direction: column;
				gap: 8px;
			}
			.toast {
				border-radius: 14px;
				padding: 10px 12px;
				color: #0b1220;
				font-weight: 600;
				box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
			}
			.toast.ok {
				background: #34d399;
			}
			.toast.err {
				background: #f87171;
			}
			.toast.info {
				background: #60a5fa;
			}

			.glow-win {
				box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.35) inset,
					0 0 0 2px rgba(34, 197, 94, 0.15),
					0 8px 30px rgba(34, 197, 94, 0.18);
				border-color: rgba(34, 197, 94, 0.35);
			}
			.badge {
				display: inline-flex;
				align-items: center;
				gap: 6px;
				padding: 6px 10px;
				border-radius: 999px;
				font-size: 12px;
				font-weight: 700;
			}
			.badge-gold {
				background: linear-gradient(135deg, #fde68a33, #f59e0b33);
				color: #fbbf24;
			}
			.badge-emerald {
				background: linear-gradient(135deg, #10b98133, #34d39933);
				color: #34d399;
			}
			.badge-slate {
				background: rgba(255, 255, 255, 0.08);
				color: #cbd5e1;
			}
			.chip {
				padding: 4px 10px;
				border-radius: 999px;
				font-size: 11px;
				font-weight: 700;
				background: rgba(255, 255, 255, 0.08);
			}
		</style>
	</head>
	<body class="min-h-screen text-slate-100">
		<div id="root"></div>

		<script type="text/babel">
			const { useEffect, useMemo, useState } = React;

			/* Icone inline */
			const Crown = (props) => (
				<svg
					viewBox="0 0 24 24"
					width="18"
					height="18"
					fill="currentColor"
					{...props}>
					<path d="M5 17h14l-1.2-8-3.8 3-2-6-2 6-3.8-3L5 17zM4 19h16v2H4z" />
				</svg>
			);
			const UserIcon = (props) => (
				<svg
					viewBox="0 0 24 24"
					width="16"
					height="16"
					fill="currentColor"
					{...props}>
					<path d="M12 12c2.76 0 5-2.24 5-5s-2.24-5-5-5S7 4.24 7 7s2.24 5 5 5zm0 2c-3.86 0-7 2.24-7 5v3h14v-3c0-2.76-3.14-5-7-5z" />
				</svg>
			);
			const Timer = (props) => (
				<svg
					viewBox="0 0 24 24"
					width="18"
					height="18"
					fill="currentColor"
					{...props}>
					<path d="M15 1H9v2h6V1zm-3 4C7.48 5 4 8.48 4 13s3.48 8 8 8 8-3.58 8-8-3.48-8-8-8zm1 8H8v-2h5v2z" />
				</svg>
			);
			const Money = (props) => (
				<svg
					viewBox="0 0 24 24"
					width="18"
					height="18"
					fill="currentColor"
					{...props}>
					<path d="M3 6h18v12H3zM5 8v8h14V8H5zm7 2a2 2 0 110 4 2 2 0 010-4z" />
				</svg>
			);
			const Flag = (props) => (
				<svg
					viewBox="0 0 24 24"
					width="14"
					height="14"
					fill="currentColor"
					{...props}>
					<path d="M4 4h10l1 2h5v10h-9l-1-2H6v6H4z" />
				</svg>
			);

			function formatCountdown(ms) {
				if (ms == null) return "â€”";
				if (ms <= 0) return "00:00";
				const total = Math.floor(ms / 1000);
				const h = Math.floor(total / 3600)
					.toString()
					.padStart(2, "0");
				const m = Math.floor((total % 3600) / 60)
					.toString()
					.padStart(2, "0");
				const s = Math.floor(total % 60)
					.toString()
					.padStart(2, "0");
				return (h !== "00" ? `${h}:` : "") + `${m}:${s}`;
			}

			function useSocket() {
				const [socket, setSocket] = useState(null);
				const [hello, setHello] = useState(null);
				const [state, setState] = useState({
					users: {},
					players: {},
					settings: {},
					now: Date.now(),
				});
				const [now, setNow] = useState(Date.now());
				const [toasts, setToasts] = useState([]);

				function pushToast(kind, text, ttl = 3000) {
					const id = Math.random().toString(36).slice(2);
					setToasts((t) => [{ id, kind, text }, ...t].slice(0, 6));
					setTimeout(
						() => setToasts((t) => t.filter((x) => x.id !== id)),
						ttl
					);
				}

				useEffect(() => {
					const s = io({ withCredentials: false });
					setSocket(s);
					s.on("hello", (msg) => setHello(msg));
					s.on("state", (st) => setState(st));
					s.on("error-msg", (e) => pushToast("err", e, 4000));
					s.on("bid:ok", ({ playerName, amount, yourRemaining }) =>
						pushToast(
							"ok",
							`Rilancio OK: ${playerName} a ${amount} â€¢ Residui: ${yourRemaining}`
						)
					);
					s.on("event:bid", ({ bidderName, playerName, amount }) =>
						pushToast("info", `${bidderName} â†’ ${playerName} a ${amount}`)
					);
					s.on("admin:ok", ({ scope, playerId }) =>
						pushToast(
							"ok",
							scope === "global"
								? "Impostazioni globali applicate"
								: `Timer giocatore ${playerId} aggiornato`
						)
					);
					return () => s.close();
				}, []);

				useEffect(() => {
					const t = setInterval(() => setNow(Date.now()), 500);
					return () => clearInterval(t);
				}, []);

				return { socket, hello, state, now, toasts, pushToast };
			}

			function Pill({ children }) {
				return (
					<span className="px-2 py-1 rounded-full text-xs font-semibold glass">
						{children}
					</span>
				);
			}

			function LastBidderBadge({ isMe, name }) {
				if (!name || name === "â€”")
					return (
						<span className="badge badge-slate">
							<UserIcon /> Nessun rilancio
						</span>
					);
				return (
					<span
						className={`badge ${isMe ? "badge-emerald" : "badge-gold"}`}>
						<Crown />
						{isMe ? "Sei in testa" : `Ultimo: ${name}`}
					</span>
				);
			}

			function AdminControlsPerPlayer({ socket, player }) {
				const [endLocal, setEndLocal] = useState(
					player.endAt
						? new Date(player.endAt).toISOString().slice(0, 16)
						: ""
				);
				const [extendSec, setExtendSec] = useState(
					player.extendOnBidSeconds ?? ""
				);

				useEffect(() => {
					setEndLocal(
						player.endAt
							? new Date(player.endAt).toISOString().slice(0, 16)
							: ""
					);
					setExtendSec(player.extendOnBidSeconds ?? "");
				}, [player.endAt, player.extendOnBidSeconds]);

				function apply() {
					const endISO = endLocal
						? new Date(endLocal).toISOString()
						: null;
					socket.emit("admin:setPlayerTimes", {
						playerId: player.id,
						endAtISO: endISO,
						extendOnBidSeconds:
							extendSec === "" ? null : Number(extendSec),
					});
				}

				return (
					<div className="mt-3 grid grid-cols-1 sm:grid-cols-3 gap-2 text-xs">
						<div>
							<label className="text-slate-300">Fine (card)</label>
							<input
								type="datetime-local"
								className="w-full mt-1 px-2 py-1 rounded-lg text-slate-900"
								value={endLocal}
								onChange={(e) => setEndLocal(e.target.value)}
							/>
						</div>
						<div>
							<label className="text-slate-300">
								Timer rilancio (s)
							</label>
							<input
								type="number"
								min="0"
								className="w-full mt-1 px-2 py-1 rounded-lg text-slate-900"
								value={extendSec}
								onChange={(e) => setExtendSec(e.target.value)}
								placeholder="vuoto = usa globale"
							/>
						</div>
						<div className="flex items-end">
							<button
								onClick={apply}
								className="w-full px-3 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-400 font-semibold">
								Applica card
							</button>
						</div>
					</div>
				);
			}

			function PlayerCard({
				player,
				me,
				usersMap,
				onBid,
				settings,
				now,
				socket,
			}) {
				const [local, setLocal] = useState(player.currentBid + 1);
				const [bump, setBump] = useState(false);
				useEffect(
					() => setLocal(Number(player.currentBid) + 1),
					[player.currentBid]
				);
				useEffect(() => {
					setBump(true);
					const t = setTimeout(() => setBump(false), 240);
					return () => clearTimeout(t);
				}, [player.currentBid]);

				const lastBidderName = player.currentBidderIp
					? usersMap[player.currentBidderIp]?.name ||
					  player.currentBidderIp
					: "â€”";

				const hasGlobalStart = !!settings.startAt;
				const beforeStart = hasGlobalStart && now < settings.startAt;
				const ext =
					(player.extendOnBidSeconds ?? settings.extendOnBidSeconds) || 0;
				const playerEndsAt =
					ext > 0 ? player.endAt : player.endAt || settings.endAt || null;
				const timeLeft = playerEndsAt ? playerEndsAt - now : null;

				const isClosed =
					player.closed || (playerEndsAt && now >= playerEndsAt);
				const myIp = me?.ip;
				const myRemaining = me?.remaining ?? 0;
				const isMeLeading =
					player.currentBidderIp && player.currentBidderIp === myIp;
				const overBudget = Number(local) > Number(myRemaining);
				const notHigher = Number(local) <= Number(player.currentBid);

				// ðŸ”’ blocco UI anche lato client se: NESSUNO startAt globale impostato
				const auctionsClosed = !hasGlobalStart;
				const canBid =
					!isClosed &&
					!beforeStart &&
					!auctionsClosed &&
					!isMeLeading &&
					!overBudget &&
					!notHigher;

				function confirmAndBid() {
					const remainAfter = myRemaining - Number(local || 0);
					const msg = `Confermi il rilancio?
Giocatore: ${player.name}
Offerta: ${local}
Ultimo prezzo: ${player.currentBid}
Crediti residui dopo rilancio: ${remainAfter >= 0 ? remainAfter : 0}`;
					if (!window.confirm(msg)) return;
					onBid(player.id, local);
				}

				return (
					<div
						className={
							"relative rounded-2xl p-4 shadow-xl border border-white/10 hover:border-white/20 transition-colors glass " +
							(isMeLeading ? "glow-win" : "")
						}>
						{/* Header */}
						<div className="flex items-center justify-between mb-3">
							<h3 className="text-lg font-semibold flex items-center gap-2">
								<span className="inline-flex h-7 w-7 items-center justify-center rounded-xl bg-indigo-500/20 border border-indigo-400/30">
									<Flag />
								</span>
								{player.name}
							</h3>
							<div className="flex items-center gap-2">
								<span className="chip">{player.team || "â€”"}</span>
								<span className="chip">ID: {player.id}</span>
							</div>
						</div>

						{/* Fascia evidenziata: Countdown + Prezzo + Ultimo */}
						<div className="mb-3 glass rounded-xl border border-white/10 px-3 py-2 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
							<div className="flex items-center gap-2 text-slate-200">
								<Timer />
								<div className="text-2xl sm:text-3xl font-extrabold tracking-tight">
									{auctionsClosed
										? "Aste chiuse"
										: beforeStart
										? "In attesa di inizioâ€¦"
										: ext > 0
										? player.endAt
											? `Resta ${formatCountdown(timeLeft)}`
											: `Timer rilancio: ${ext}s`
										: `Termina tra ${formatCountdown(timeLeft)}`}
								</div>
							</div>
							<div className="flex items-center gap-3">
								{!beforeStart && !auctionsClosed ? (
									<div className="flex items-center gap-2">
										<Money />
										<div
											className={
												"text-2xl sm:text-3xl font-extrabold price " +
												(bump ? "price-bump" : "")
											}>
											{player.currentBid}
										</div>
									</div>
								) : (
									<div className="text-slate-400 text-sm">
										Prezzo visibile all'inizio
									</div>
								)}
								<LastBidderBadge
									isMe={isMeLeading}
									name={lastBidderName}
								/>
							</div>
						</div>

						{/* Bid controls */}
						<div className="flex items-center gap-2">
							<button
								className="px-3 py-2 rounded-xl glass border border-white/10 hover:border-white/20"
								onClick={() =>
									setLocal((v) =>
										Math.max(
											Number(player.currentBid) + 1,
											Number(v) - 1
										)
									)
								}
								disabled={isClosed || beforeStart || auctionsClosed}>
								âˆ’
							</button>
							<input
								type="number"
								className="w-24 px-3 py-2 rounded-xl text-slate-900"
								value={local}
								min={player.currentBid + 1}
								onChange={(e) => setLocal(Number(e.target.value))}
								disabled={isClosed || beforeStart || auctionsClosed}
							/>
							<button
								className="px-3 py-2 rounded-xl glass border border-white/10 hover:border-white/20"
								onClick={() => setLocal((v) => Number(v) + 1)}
								disabled={isClosed || beforeStart || auctionsClosed}>
								+
							</button>
						</div>

						<button
							disabled={!canBid}
							onClick={confirmAndBid}
							className={
								"mt-2 w-full py-3 rounded-xl font-semibold transition-colors " +
								(canBid
									? "bg-indigo-500 hover:bg-indigo-400"
									: "bg-slate-600 cursor-not-allowed")
							}>
							{auctionsClosed
								? "Aste chiuse"
								: beforeStart
								? "In attesa di inizioâ€¦"
								: `Rilancia a ${local}`}
						</button>

						{/* Admin per-player controls */}
						{me?.isAdmin && (
							<AdminControlsPerPlayer socket={socket} player={player} />
						)}
					</div>
				);
			}

			function AdminPanel({ socket, settings, now }) {
				const [startLocal, setStartLocal] = useState(
					settings.startAt
						? new Date(settings.startAt).toISOString().slice(0, 16)
						: ""
				);
				const [endLocal, setEndLocal] = useState(
					settings.endAt
						? new Date(settings.endAt).toISOString().slice(0, 16)
						: ""
				);
				const [extendSec, setExtendSec] = useState(
					settings.extendOnBidSeconds || 0
				);

				useEffect(() => {
					setStartLocal(
						settings.startAt
							? new Date(settings.startAt).toISOString().slice(0, 16)
							: ""
					);
					setEndLocal(
						settings.endAt
							? new Date(settings.endAt).toISOString().slice(0, 16)
							: ""
					);
					setExtendSec(settings.extendOnBidSeconds || 0);
				}, [settings]);

				const startCountdown = settings.startAt
					? settings.startAt - now
					: null;
				const endCountdown =
					extendSec > 0
						? null
						: settings.endAt
						? settings.endAt - now
						: null;

				function apply() {
					const startISO = startLocal
						? new Date(startLocal).toISOString()
						: null;
					const endISO = endLocal
						? new Date(endLocal).toISOString()
						: null;
					socket.emit("admin:setTimes", {
						startAtISO: startISO,
						endAtISO: endISO,
						extendOnBidSeconds: Number(extendSec || 0),
					});
				}

				return (
					<div className="glass rounded-2xl p-4 border border-white/10">
						<div className="flex items-center justify-between mb-3">
							<h2 className="text-lg font-semibold">
								Pannello Amministratore
							</h2>
							<div className="text-xs text-slate-300">
								Server time: {new Date(now).toLocaleString()}
							</div>
						</div>

						<div className="grid grid-cols-1 md:grid-cols-3 gap-3">
							<div>
								<label className="text-sm text-slate-300">
									Inizio asta (obbligatorio per aprire)
								</label>
								<input
									type="datetime-local"
									className="w-full mt-1 px-3 py-2 rounded-xl text-slate-900"
									value={startLocal}
									onChange={(e) => setStartLocal(e.target.value)}
								/>
								<div className="text-xs text-slate-400 mt-1">
									Parte tra:{" "}
									<span className="font-semibold">
										{formatCountdown(startCountdown)}
									</span>
								</div>
							</div>
							<div>
								<label className="text-sm text-slate-300">
									Fine asta (globale)
								</label>
								<input
									type="datetime-local"
									className="w-full mt-1 px-3 py-2 rounded-xl text-slate-900"
									value={endLocal}
									onChange={(e) => setEndLocal(e.target.value)}
									disabled={Number(extendSec) > 0}
								/>
								<div className="text-xs text-slate-400 mt-1">
									Termina tra:{" "}
									<span className="font-semibold">
										{formatCountdown(endCountdown)}
									</span>
								</div>
							</div>
							<div>
								<label className="text-sm text-slate-300">
									Timer di rilancio (sec) â€“ default
								</label>
								<input
									type="number"
									min="0"
									className="w-full mt-1 px-3 py-2 rounded-xl text-slate-900"
									value={extendSec}
									onChange={(e) => setExtendSec(e.target.value)}
								/>
								<div className="text-xs text-slate-400 mt-1">
									Se &gt; 0, ogni offerta resetta il countdown della
									card (se la card non ha override).
								</div>
							</div>
						</div>

						<button
							onClick={apply}
							className="mt-4 w-full md:w-auto px-4 py-2 rounded-xl font-semibold bg-emerald-500 hover:bg-emerald-400">
							Applica impostazioni globali
						</button>
					</div>
				);
			}

			function App() {
				const { socket, hello, state, now, toasts } = useSocket();
				const me = useMemo(() => {
					if (!hello) return null;
					return {
						ip: hello.ip,
						recognized: hello.recognized,
						name: hello.name,
						credits: hello.credits,
						remaining: hello.remaining,
						isAdmin: hello.isAdmin,
					};
				}, [hello]);

				const usersMap = state.users || {};
				const players = Object.values(state.players || {});
				const settings = state.settings || {};

				function bid(playerId, amount) {
					if (socket)
						socket.emit("bid", { playerId, amount: Number(amount) });
				}

				const startCountdown = settings.startAt
					? settings.startAt - now
					: null;
				const auctionsClosed = !settings.startAt;
				const auctionNotStarted = settings.startAt && startCountdown > 0;

				return (
					<div className="max-w-7xl mx-auto p-6 space-y-6">
						{/* Toasts */}
						<div className="toast-wrap">
							{toasts.map((t) => (
								<div key={t.id} className={`toast ${t.kind}`}>
									{t.text}
								</div>
							))}
						</div>

						<header className="glass shine rounded-2xl p-4 border border-white/10">
							<div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
								<div>
									<h1 className="text-2xl font-bold">
										Asta Fantacalcio Live
									</h1>
									<p className="text-slate-300 text-sm flex items-center gap-2">
										<Timer />{" "}
										{settings.extendOnBidSeconds > 0 ? (
											<>
												ModalitÃ {" "}
												<span className="font-semibold">
													timer di rilancio
												</span>{" "}
												default:{" "}
												<span className="font-semibold">
													{settings.extendOnBidSeconds}s
												</span>
												.
											</>
										) : settings.endAt ? (
											<>
												Fine asta globale:{" "}
												<span className="font-semibold">
													{new Date(
														settings.endAt
													).toLocaleString()}
												</span>
											</>
										) : (
											<>Nessuna fine globale impostata.</>
										)}
									</p>
								</div>
								<div className="text-sm">
									{me?.recognized ? (
										<div className="flex items-center gap-3">
											<span className="inline-flex items-center gap-2 chip">
												<UserIcon /> {me.name}{" "}
												{me.isAdmin && (
													<span className="ml-1 text-amber-300">
														(Admin)
													</span>
												)}
											</span>
											<span className="chip">
												Crediti:{" "}
												<span className="font-semibold ml-1">
													{me.credits}
												</span>
											</span>
											<span className="chip">
												Residui:{" "}
												<span className="font-semibold ml-1">
													{me.remaining}
												</span>
											</span>
											<span className="chip font-mono">{me.ip}</span>
										</div>
									) : (
										<>
											Ospite â€” usa{" "}
											<span className="font-mono">?ip=...</span> per
											simulare
										</>
									)}
								</div>
							</div>
							{auctionsClosed && (
								<div className="mt-3 text-xs text-amber-300">
									Aste ancora chiuse: imposta lâ€™
									<span className="font-semibold">inizio</span> dal
									pannello admin.
								</div>
							)}
							{auctionNotStarted && (
								<div className="mt-2 text-xs text-amber-300">
									Lâ€™asta inizierÃ  tra:{" "}
									<span className="font-semibold">
										{formatCountdown(startCountdown)}
									</span>
								</div>
							)}
						</header>

						{me?.isAdmin && (
							<div>
								<AdminPanel
									socket={socket}
									settings={settings}
									now={now}
								/>
							</div>
						)}

						<section className="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4">
							{players.map((p) => (
								<PlayerCard
									key={p.id}
									player={p}
									me={me}
									usersMap={usersMap}
									onBid={bid}
									settings={settings}
									now={now}
									socket={socket}
								/>
							))}
						</section>
					</div>
				);
			}

			ReactDOM.createRoot(document.getElementById("root")).render(<App />);
		</script>
	</body>
</html>
